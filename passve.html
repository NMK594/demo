<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>V√© c·ªßa t√¥i - B√°n L·∫°i V√©</title>
    <!-- Gi·∫£ ƒë·ªãnh file styletang.css ƒë√£ c√≥ ƒë·ªãnh nghƒ©a cho c√°c modal -->
    <link rel="stylesheet" href="styletang.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* Styles for sell-price input row and disabled button state */
      .sell-price-row {
        display: none;
        margin-top: 10px;
        gap: 8px;
        align-items: center;
      }
      .ticket-item.selected .sell-price-row {
        display: flex;
        flex-wrap: wrap;
      }
      .sell-price-input {
        appearance: none;
        -webkit-appearance: none;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        width: 140px;
        box-sizing: border-box;
      }
      .sell-price-note {
        font-size: 13px;
        color: #cfe3ff;
      }
      .sell-price-error {
        color: #ffb4b4;
        font-size: 13px;
        margin-left: 6px;
      }
      .btn-gift.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      /* Custom styles for Dark Theme (Optional, for better visual) */
      .ticket-item {
        background: #1e1e1e;
        border: 1px solid #333;
        color: #e0e0e0;
      }
      .ticket-item.selected {
        border-color: #8ab4f8;
        background: #252525;
      }
      .event-title {
        color: #fff;
      }
      .tag.success {
        background: #1a4d33;
        color: #a4e5c8;
      }
    </style>
  </head>
  <body>
    <div class="phone-frame">
      <div class="status-bar">
        <span>10:08</span>
        <div>
          <i class="bi bi-wifi"></i>
          <span></span>
          <i class="bi bi-battery-half"></i>
        </div>
      </div>

      <div class="header-title">
        <a href="chitietve2.html" class="back-button">
          <i class="bi bi-arrow-left"></i>
        </a>
        <h2>Pass v√©</h2>
      </div>

      <!-- L·ªöP PH·ª¶ X√ÅC TH·ª∞C PIN/OTP -->
      <div class="pin-overlay hidden">
        <!-- 1. H·ªòP NH·∫¨P PIN -->
        <div class="pin-box">
          <h3>Nh·∫≠p m√£ PIN x√°c th·ª±c</h3>
          <div class="pin-dots">
            <span></span><span></span><span></span> <span></span><span></span
            ><span></span>
          </div>
          <div class="pin-keypad">
            <button>1</button><button>2</button><button>3</button>
            <button>4</button><button>5</button><button>6</button>
            <button>7</button><button>8</button><button>9</button>
            <div></div>
            <button>0</button><button class="del">‚å´</button>
          </div>
        </div>

        <!-- 2. H·ªòP X√ÅC TH·ª∞C OTP (M·∫∂C ƒê·ªäNH ·∫®N) -->
        <div class="otp-box hidden">
          <h3 class="otp-title">X√°c th·ª±c Digital OTP</h3>
          <div class="otp-code-container">
            <div class="otp-code-display">
              <span></span><span></span><span></span><span></span> <span></span
              ><span></span><span></span><span></span>
            </div>
          </div>
          <p class="otp-timer-text">
            M√£ x√°c th·ª±c giao d·ªãch (OTP) c√≥ hi·ªáu l·ª±c trong v√≤ng
            <span id="otp-timer">45</span> gi√¢y
          </p>
          <button class="otp-verify-btn">X√°c th·ª±c</button>
        </div>
      </div>

      <!-- CUSTOM SUCCESS MODAL (THAY TH·∫æ ALERT) -->
      <div class="custom-modal-overlay hidden" id="successModal">
        <div class="custom-modal">
          <h4>Y√™u c·∫ßu th√†nh c√¥ng!</h4>
          <p>
            Y√™u c·∫ßu b√°n v√© ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi. V√© c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n s√†n
            giao d·ªãch sau khi h·ªá th·ªëng ki·ªÉm duy·ªát.
          </p>
          <a
            href="chitietve1.html"
            class="modal-btn-ok link-as-button"
            id="btnOk"
            >Ho√†n t·∫•t</a
          >
        </div>
      </div>

      <div class="tabs-container">
        <button class="tab active" data-tab="upcoming">V√© c·ªßa t√¥i</button>
      </div>

      <div class="content-wrapper">
        <div id="upcoming" class="tab-content active">
          <div class="ticket-link">
            <div class="ticket-item" data-original-price="120000">
              <div class="select-box">
                <label
                  ><input
                    type="checkbox"
                    class="ticket-checkbox"
                    aria-label="Ch·ªçn v√©"
                /></label>
              </div>
              <div class="date-col">
                <span class="day">24</span>
                <span class="month">Th√°ng 11</span>
                <span class="year">2025</span>
              </div>
              <div class="info-col">
                <div class="circle top"></div>
                <div class="circle bottom"></div>
                <p class="event-title">LIVE CONCERT SKYNOTE 2025</p>
                <div class="tags">
                  <span class="tag success">Ch∆∞a s·ª≠ d·ª•ng</span>
                  <span class="tag ticket">V√© ƒëi·ªán t·ª≠</span>
                </div>
                <p class="detail-line">
                  <span class="icon">üïë</span> 19:00, 24 Th√°ng 11, 2025
                </p>
                <p class="detail-line">
                  <span class="icon">üìç</span> S·ªë v√©: C478
                </p>
                <!-- sell price row (hidden until selected) -->
                <div class="sell-price-row">
                  <input
                    type="number"
                    class="sell-price-input"
                    min="0"
                    placeholder="Gi√° b√°n (VND)"
                  />
                  <div class="sell-price-note">
                    T·ªëi ƒëa: <strong class="orig-price">120000</strong>VND
                  </div>
                  <div class="sell-price-error" aria-live="polite"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="ticket-item" data-original-price="120000">
            <div class="select-box">
              <label
                ><input
                  type="checkbox"
                  class="ticket-checkbox"
                  aria-label="Ch·ªçn v√©"
              /></label>
            </div>
            <div class="date-col">
              <span class="day">20</span>
              <span class="month">Th√°ng 12</span>
              <span class="year">2025</span>
            </div>
            <div class="info-col">
              <div class="circle top"></div>
              <div class="circle bottom"></div>
              <p class="event-title">Y-CONCERT BY YEAH1</p>
              <div class="tags">
                <span class="tag success">Ch∆∞a s·ª≠ d·ª•ng</span>
                <span class="tag ticket">V√© ƒëi·ªán t·ª≠</span>
              </div>
              <p class="detail-line">
                <span class="icon">üïë</span> 14:00, 20 Th√°ng 12, 2025
              </p>
              <p class="detail-line">
                <span class="icon">üìç</span> S·ªë v√©: A764
              </p>
              <!-- sell price row (hidden until selected) -->
              <div class="sell-price-row">
                <input
                  type="number"
                  class="sell-price-input"
                  min="0"
                  placeholder="Gi√° b√°n (VND)"
                />
                <div class="sell-price-note">
                  T·ªëi ƒëa: <strong class="orig-price">120000</strong>VND
                </div>
                <div class="sell-price-error" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="gift-wrap">
          <a class="btn-gift" role="button" aria-label="T·∫∑ng v√©">B√°n v√©</a>
        </div>
        <div class="suggestion-cards"></div>
      </div>

      <div class="footer-nav">
        <div class="nav-item">
          <span class="icon-text">t</span>
          <span class="label">Trang ch·ªß</span>
        </div>
        <div class="nav-item active">
          <span class="icon-active"></span>
          <span class="label">V√© c·ªßa t√¥i</span>
        </div>
        <div class="nav-item">
          <span class="icon-text">üë§</span>
          <span class="label">T√†i kho·∫£n</span>
        </div>
      </div>
      <div class="android-nav-bar">
        <span>&#9776;</span>
        <span>&#9675;</span>
        <span>&#9633;</span>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
      // --- PIN/OTP/MODAL ELEMENTS ---
      const pinOverlay = document.querySelector(".pin-overlay");
      const pinBox = pinOverlay.querySelector(".pin-box");
      const otpBox = pinOverlay.querySelector(".otp-box");
      const otpTimerDisplay = pinOverlay.querySelector("#otp-timer");
      const otpCodeSpans = pinOverlay.querySelectorAll(
        ".otp-code-display span"
      );
      const otpVerifyBtn = pinOverlay.querySelector(".otp-verify-btn");
      const dotsPin = pinOverlay.querySelectorAll(".pin-dots span");
      const keypad = pinOverlay.querySelectorAll(".pin-keypad button");
      const successModal = document.getElementById("successModal");
      const btnOk = document.getElementById("btnOk");

      let pin = "";
      const correctPIN = "050904"; // M√£ PIN m·∫´u
      let otpTimer;
      let currentOTP = "";
      let sellingData = []; // L∆∞u d·ªØ li·ªáu v√© ƒëang ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ b√°n

      // --- AUTHENTICATION LOGIC ---

      /**
       * B·∫Øt ƒë·∫ßu qu√° tr√¨nh x√°c th·ª±c b·∫±ng c√°ch hi·ªÉn th·ªã m√†n h√¨nh PIN.
       * @param {Array} data - Danh s√°ch c√°c v√© ƒëang b√°n.
       */
      function showPINOverlay(data) {
        sellingData = data; // L∆∞u d·ªØ li·ªáu v√©

        // D·ª´ng v√† x√≥a b·ªô ƒë·∫øm c≈© n·∫øu c√≥ (an to√†n)
        if (otpTimer) clearInterval(otpTimer);

        // ƒê·∫£m b·∫£o ch·ªâ PIN box hi·ªÉn th·ªã
        otpBox.classList.add("hidden");
        pinBox.classList.remove("hidden");

        // HI·ªÇN TH·ªä L·ªöP PH·ª¶ CHUNG
        pinOverlay.classList.remove("hidden");

        // ƒê·∫∑t l·∫°i tr·∫°ng th√°i PIN
        pin = "";
        dotsPin.forEach((d) => d.classList.remove("filled"));
      }

      /**
       * X·ª≠ l√Ω ƒë·∫ßu v√†o t·ª´ b√†n ph√≠m s·ªë
       */
      keypad.forEach((btn) => {
        btn.onclick = () => {
          // Ch·ªâ x·ª≠ l√Ω khi PIN BOX ƒëang hi·ªÉn th·ªã
          if (pinBox.classList.contains("hidden")) return;

          const val = btn.textContent;

          if (btn.classList.contains("del")) pin = pin.slice(0, -1);
          else if (pin.length < 6) pin += val;

          // C·∫≠p nh·∫≠t ch·∫•m PIN
          dotsPin.forEach((d, i) =>
            d.classList.toggle("filled", i < pin.length)
          );

          if (pin.length === 6) {
            if (pin === correctPIN) {
              // CHUY·ªÇN T·ª™ PIN SANG OTP
              pinBox.classList.add("hidden");
              otpBox.classList.remove("hidden");
              startOTPCountdown();
            } else {
              // Hi·ªáu ·ª©ng l·ªói PIN sai
              pin = "";
              dotsPin.forEach((d) => d.classList.remove("filled"));
              pinBox.animate(
                [
                  { transform: "translateX(-8px)" },
                  { transform: "translateX(8px)" },
                  { transform: "translateX(-8px)" },
                  { transform: "translateX(0)" },
                ],
                { duration: 300 }
              );
            }
          }
        };
      });

      /**
       * Logic ƒê·∫øm ng∆∞·ª£c v√† T·∫°o m√£ OTP.
       */
      function startOTPCountdown() {
        let timeLeft = 45; // 45 gi√¢y ƒë·∫øm ng∆∞·ª£c

        function generateOTP() {
          // M√£ h√≥a d·ªØ li·ªáu (v√≠ d·ª•: m√£ PIN + th·ªùi gian) ƒë·ªÉ t·∫°o OTP duy nh·∫•t
          const base = correctPIN + Date.now().toString();
          let hash =
            typeof CryptoJS !== "undefined"
              ? CryptoJS.SHA256(base).toString().substring(0, 8) // L·∫•y 8 k√Ω t·ª± ƒë·∫ßu
              : "DEMO" + Math.floor(Math.random() * 9000 + 1000);

          // T·∫°o m√£ OTP 8 ch·ªØ s·ªë t·ª´ hash (ch·ªâ l·∫•y s·ªë)
          let otpCode = hash.replace(/\D/g, "").substring(0, 8);
          while (otpCode.length < 8) {
            otpCode += Math.floor(Math.random() * 10);
          }

          otpCodeSpans.forEach((span, index) => {
            span.textContent = otpCode[index];
          });
          currentOTP = otpCode; // L∆∞u OTP hi·ªán t·∫°i
          return otpCode;
        }

        function updateTimer() {
          otpTimerDisplay.textContent = timeLeft;
          if (timeLeft <= 0) {
            clearInterval(otpTimer);
            // T·∫°o OTP m·ªõi v√† b·∫Øt ƒë·∫ßu l·∫°i ƒë·∫øm ng∆∞·ª£c
            startOTPCountdown();
            return; // NgƒÉn ch·∫∑n timeLeft-- khi ƒë√£ h·∫øt gi·ªù
          }
          timeLeft--;
        }

        if (otpTimer) clearInterval(otpTimer);

        generateOTP();
        updateTimer();
        otpTimer = setInterval(updateTimer, 1000);
      }

      // --- FORM AND FINAL ACTION LOGIC ---

      /**
       * Logic khi nh·∫•n n√∫t "X√°c th·ª±c" tr√™n m√†n h√¨nh OTP
       */
      otpVerifyBtn.onclick = () => {
        // Ch·ªâ x·ª≠ l√Ω khi OTP BOX ƒëang hi·ªÉn th·ªã
        if (otpBox.classList.contains("hidden")) return;

        // D·ª´ng b·ªô ƒë·∫øm OTP
        clearInterval(otpTimer);

        // ƒê·∫£m b·∫£o ·∫©n l·ªõp ph·ªß PIN/OTP
        pinBox.classList.add("hidden");
        otpBox.classList.add("hidden");
        pinOverlay.classList.add("hidden");

        // 3. X·ª≠ l√Ω logic G·ª≠i y√™u c·∫ßu B√°n (th√†nh c√¥ng)
        console.log("X√°c th·ª±c th√†nh c√¥ng. G·ª≠i y√™u c·∫ßu b√°n v√©...");
        console.log("V√© ƒëang b√°n:", sellingData, "OTP:", currentOTP);

        // 4. Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng (Custom Modal)
        successModal.classList.remove("hidden");
      };

      document.addEventListener("DOMContentLoaded", () => {
        const sellBtn = document.querySelector(".btn-gift");
        const ticketItems = document.querySelectorAll(".ticket-item");

        // B·ªï sung: NgƒÉn click v√†o item t·ªïng th·ªÉ ƒë·ªÉ tr√°nh xung ƒë·ªôt
        ticketItems.forEach((item) => {
          item.addEventListener("click", (e) => {
            // Ch·ªâ cho ph√©p click v√†o checkbox ho·∫∑c input
            if (
              !e.target.classList.contains("ticket-checkbox") &&
              !e.target.closest(".ticket-checkbox") &&
              !e.target.classList.contains("sell-price-input")
            ) {
              e.stopPropagation();
            }
          });
        });

        // populate displayed original prices from data-original-price (robust: avoid NaN)
        ticketItems.forEach((item) => {
          const origValue = item.dataset.originalPrice;
          const orig = origValue ? Number(origValue) : 0;
          const origSpan = item.querySelector(".orig-price");
          if (origSpan)
            origSpan.textContent = orig ? orig.toLocaleString("vi-VN") : "‚Äî";
          item.dataset.originalPrice = String(orig);
        });

        // stop clicks inside inputs / sell-price-row from bubbling to parent
        ticketItems.forEach((item) => {
          const inputs = item.querySelectorAll("input, .sell-price-row");
          inputs.forEach((el) => {
            el.addEventListener("click", (e) => e.stopPropagation());
            el.addEventListener("mousedown", (e) => e.stopPropagation());
            el.addEventListener("touchstart", (e) => e.stopPropagation());
          });
        });

        function updateSellState() {
          let anySelected = false;
          let allValid = true;

          // *--- FIX L·ªñI: RESET V√Ä POPULATE sellingData ---*
          sellingData = [];

          ticketItems.forEach((item) => {
            const cb = item.querySelector(".ticket-checkbox");
            const input = item.querySelector(".sell-price-input");
            const err = item.querySelector(".sell-price-error");
            const orig = Number(item.dataset.originalPrice || 0);

            // L·∫•y ID v√© (ƒë∆∞·ª£c s·ª≠ d·ª•ng khi populating sellingData)
            const ticketIdElement = item.querySelector(
              ".detail-line:nth-child(4)"
            );
            const ticketId = ticketIdElement
              ? ticketIdElement.textContent.split(":").pop().trim()
              : "N/A";
            // *--------------------------------------------*

            if (cb && cb.checked) item.classList.add("selected");
            else item.classList.remove("selected");

            if (cb && cb.checked) {
              anySelected = true;
              const val =
                input && input.value !== "" ? Number(input.value) : NaN;

              if (!input || isNaN(val)) {
                allValid = false;
                if (err) err.textContent = "Vui l√≤ng nh·∫≠p gi√° b√°n";
              } else if (orig > 0 && val > orig) {
                allValid = false;
                if (err)
                  err.textContent =
                    "Gi√° ph·∫£i ‚â§ " + orig.toLocaleString("vi-VN") + "‚Ç´";
              } else if (val <= 0) {
                allValid = false;
                if (err) err.textContent = "Gi√° ph·∫£i l·ªõn h∆°n 0";
              } else {
                if (err) err.textContent = "";
                // *--- FIX L·ªñI: TH√äM D·ªÆ LI·ªÜU V√â H·ª¢P L·ªÜ ---*
                sellingData.push({
                  ticketId: ticketId,
                  originalPrice: orig,
                  sellingPrice: val,
                });
                // *---------------------------------------*
              }
            } else {
              if (err) err.textContent = "";
            }
          });

          if (!anySelected || !allValid) {
            sellBtn.classList.add("disabled");
            sellBtn.setAttribute("aria-disabled", "true");
          } else {
            sellBtn.classList.remove("disabled");
            sellBtn.removeAttribute("aria-disabled");
          }
        }

        // attach listeners
        ticketItems.forEach((item) => {
          const cb = item.querySelector(".ticket-checkbox");
          const input = item.querySelector(".sell-price-input");

          if (cb) cb.addEventListener("change", () => updateSellState());
          if (input) {
            input.addEventListener("input", () => updateSellState());
            // ensure focusing input doesn't toggle parent selection
            input.addEventListener("focus", (e) => e.stopPropagation());
          }
        });

        updateSellState();

        // G·ª≠i y√™u c·∫ßu b√°n (B√¢y gi·ªù s·∫Ω k√≠ch ho·∫°t PIN/OTP)
        sellBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (sellBtn.classList.contains("disabled")) {
            return;
          }

          // Ki·ªÉm tra l·∫°i l·∫ßn cu·ªëi (B√¢y gi·ªù sellingData ƒë√£ ƒë∆∞·ª£c populate ƒë√∫ng)
          if (sellingData.length === 0) {
            console.error(
              "L·ªói: Kh√¥ng c√≥ v√© n√†o ƒë∆∞·ª£c ch·ªçn ho·∫∑c gi√° kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i."
            );
            return;
          }

          // B·∫Øt ƒë·∫ßu qu√° tr√¨nh x√°c th·ª±c PIN
          showPINOverlay(sellingData);
        });
      });
    </script>
  </body>
</html>
